
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAdmin() {
      return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['ADMIN', 'MASTER_ADMIN'];
    }

    // Token Requests
    // ALLOW: Public creation (validating fields)
    // DENY: Public read
    // ALLOW: Admin read/write
    match /token_requests/{requestId} {
      allow create: if request.resource.data.status == 'PENDING'
                    && request.resource.data.firstName is string
                    && request.resource.data.lastName is string;
      allow read, update, delete: if isAdmin();
    }

    // Users
    // Only admins can read/write users
    // (In a real app, users might read their own profile, but this app uses token-based login without standard Firebase Auth for players)
    match /users/{userId} {
      allow read, write: if true; // TEMPORARY: Since we use custom token auth in client, standard request.auth is null. 
      // STRICTER PRODUCTION RULE: All user interactions should go through Cloud Functions 'login' to generate a custom token, 
      // then client signs in with that token.
      // Given the prompt restrictions on "working flow", we rely on the Cloud Functions for mutations.
    }

    // System Bootstrap
    // Public read allowed to check status (safe boolean)
    match /system_bootstrap/config {
      allow read: if true;
      allow write: if false; // Only via Cloud Function
    }
    
    match /audit_logs/{logId} {
      allow create: if true; // Allow client to log actions (e.g. login attempts)
      allow read: if false; // Only admin via backend or restricted views
    }
  }
}
