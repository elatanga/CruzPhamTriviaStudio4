
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- CUSTOM AUTH ARCHITECTURE NOTES ---
    // This app uses a custom username/token system stored in the 'users' collection.
    // It does NOT use standard Firebase Auth for user management.
    // Therefore, request.auth.uid will usually be null or anonymous.
    // Writes are primarily handled via Cloud Functions (Admin SDK).

    // 1. TOKEN REQUESTS
    // Allow read for Admins (in this context, we allow read to support the Admin Panel UI).
    // Writes are strictly restricted to Cloud Functions (Server Authoritative) to ensure ID generation and notification triggers.
    match /token_requests/{requestId} {
      allow read: if true; 
      allow create, update, delete: if false; // Must use Cloud Functions
    }

    // 2. USERS
    // Required: 'read' must be true so the LoginScreen can query `where("username", "==", input)`
    // Writes are strictly forbidden from client; must use `authService` (Cloud Functions).
    match /users/{userId} {
      allow read: if true;
      allow write: if false; 
    }

    // 3. SYSTEM BOOTSTRAP
    // Required: App must check this on load to decide whether to show Login or Bootstrap screen.
    match /system_bootstrap/config {
      allow read: if true;
      allow write: if false; // Only via Cloud Function bootstrapSystem
    }
    
    // 4. AUDIT LOGS
    // Allow client to write logs (e.g. login attempts)
    match /audit_logs/{logId} {
      allow create: if true;
      allow read: if true;
    }
  }
}
